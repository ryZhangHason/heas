import {
  APP_VERSION,
  EXPORT_BUNDLE_VERSION,
  PLAYGROUND_CONFIG_VERSION,
  PLAYGROUND_RUN_RESULT_VERSION,
} from "./state.js";
import { ERROR_CODES, createError } from "./errors.js";

function nowIso() {
  return new Date().toISOString();
}

function clampInt(value, fallback) {
  const n = Number(value);
  if (!Number.isFinite(n)) return fallback;
  return Math.max(1, Math.floor(n));
}

function extractControls(raw = {}) {
  const controls = raw.controls && typeof raw.controls === "object" ? raw.controls : {};
  return {
    steps: clampInt(controls.steps ?? raw.steps, 20),
    episodes: clampInt(controls.episodes ?? raw.episodes, 1),
    seed: Number(controls.seed ?? raw.seed ?? 123),
  };
}

export function buildConfigV2({ mode, layers, controls, notes = "" }) {
  return {
    version: PLAYGROUND_CONFIG_VERSION,
    app_version: APP_VERSION,
    mode,
    layers,
    controls: {
      steps: clampInt(controls?.steps, 20),
      episodes: clampInt(controls?.episodes, 1),
      seed: Number(controls?.seed ?? 123),
    },
    created_at: nowIso(),
    notes: typeof notes === "string" ? notes : "",
  };
}

export function buildRunPayload(configV2, layersOverride = null) {
  const controls = extractControls(configV2);
  return {
    version: PLAYGROUND_CONFIG_VERSION,
    steps: controls.steps,
    episodes: controls.episodes,
    seed: controls.seed,
    layers: Array.isArray(layersOverride) ? layersOverride : configV2.layers,
  };
}

export function summarizeRunEpisodes(episodes = []) {
  if (!Array.isArray(episodes) || !episodes.length) {
    return { episode_count: 0, metric_keys: [] };
  }
  const first = episodes[0]?.episode || {};
  return {
    episode_count: episodes.length,
    metric_keys: Object.keys(first),
  };
}

export function buildRunResultV2({
  runId,
  configHash,
  engineVersion,
  limitsApplied,
  episodes,
  warnings = [],
  errors = [],
}) {
  return {
    version: PLAYGROUND_RUN_RESULT_VERSION,
    run_id: runId,
    config_hash: configHash,
    engine: {
      runtime: "pyodide",
      engine_version: engineVersion || "pyodide-unknown",
      app_version: APP_VERSION,
    },
    limits_applied: limitsApplied || {},
    episodes: Array.isArray(episodes) ? episodes : [],
    summary: summarizeRunEpisodes(episodes),
    warnings,
    errors,
    created_at: nowIso(),
  };
}

export function buildExportBundleV2({ config, result, report, checksums = {} }) {
  return {
    version: EXPORT_BUNDLE_VERSION,
    config,
    result: result || null,
    report: report || null,
    checksums,
    created_at: nowIso(),
  };
}

function migrateV1Config(raw) {
  const controls = extractControls(raw);
  return {
    version: PLAYGROUND_CONFIG_VERSION,
    app_version: raw.app_version || APP_VERSION,
    mode: raw.mode || "sample1",
    layers: Array.isArray(raw.layers) ? raw.layers : [],
    controls,
    created_at: raw.created_at || nowIso(),
    notes: typeof raw.notes === "string" ? raw.notes : "",
  };
}

export function migrateIncomingConfig(rawConfig) {
  if (!rawConfig || typeof rawConfig !== "object") {
    throw createError(
      ERROR_CODES.compat.MIGRATION_FAILED,
      "Config payload is not an object.",
      ["Import a valid configuration or bundle file."]
    );
  }
  const version = rawConfig.version;
  if (version === PLAYGROUND_CONFIG_VERSION) {
    const controls = extractControls(rawConfig);
    return {
      ...rawConfig,
      controls,
      layers: Array.isArray(rawConfig.layers) ? rawConfig.layers : [],
      app_version: rawConfig.app_version || APP_VERSION,
      mode: rawConfig.mode || "sample1",
      created_at: rawConfig.created_at || nowIso(),
      notes: typeof rawConfig.notes === "string" ? rawConfig.notes : "",
    };
  }
  if (version === "PlaygroundConfigV1" || !version) {
    return migrateV1Config(rawConfig);
  }
  throw createError(
    ERROR_CODES.compat.UNKNOWN_CONFIG_VERSION,
    `Unsupported config version '${version}'.`,
    ["Export with the current version and re-import.", "Use an older bundle generated by this playground."],
    { version }
  );
}

export function migrateIncomingBundle(rawBundle) {
  if (!rawBundle || typeof rawBundle !== "object") {
    throw createError(
      ERROR_CODES.compat.MIGRATION_FAILED,
      "Bundle payload is not an object.",
      ["Import a valid JSON bundle."]
    );
  }

  const maybeConfig = rawBundle.config || rawBundle;
  const config = migrateIncomingConfig(maybeConfig);
  const uiMode = rawBundle?.ui_state?.mode || rawBundle?.view || config.mode || "sample1";

  let result = rawBundle.result || null;
  if (result && typeof result === "object" && result.version === "PlaygroundRunResultV1") {
    result = {
      version: PLAYGROUND_RUN_RESULT_VERSION,
      run_id: result.run_id,
      config_hash: result.config_hash,
      engine: {
        runtime: "pyodide",
        engine_version: result.engine_version || "pyodide-unknown",
        app_version: result.app_version || APP_VERSION,
      },
      limits_applied: result.limits_applied || {},
      episodes: result.episodes || [],
      summary: summarizeRunEpisodes(result.episodes || []),
      warnings: result.warnings || [],
      errors: result.errors || [],
      created_at: result.started_at || nowIso(),
    };
  }

  return {
    config,
    result,
    mode: uiMode,
  };
}
