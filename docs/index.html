<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>HEAS Playground</title>
  <link rel="icon" type="image/svg+xml" href="favicon.svg" />
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <header class="hero">
    <div class="hero-inner container">
      <p class="eyebrow">HEAS • Hierarchical Evolutionary Agent Simulation</p>
      <div class="hero-title-row">
        <img src="./favicon.svg" alt="HEAS logo" class="hero-logo-inline" />
        <h1>HEAS Web Playground</h1>
      </div>
      <p class="sub">
        HEAS is a framework for building hierarchical agent simulations, running evolutionary search, comparing strategies via
        scenarios × participants (arena & tournament), and generating clean visualizations.
        <span class="citation">Zhang, Ruiyu, Nie, Lin, Zhao, Xin. (2025). HEAS: Hierarchical Evolutionary Agent Simulation Framework for Cross-Scale Modeling and Multi-Objective Search. arXiv preprint arXiv:2508.15555</span>
      </p>
    </div>
  </header>

  <section class="nav-strip">
    <div class="container nav-buttons">
      <button id="sample1Btn" type="button" class="btn">Sample Usage 1</button>
      <button id="sample2Btn" type="button" class="btn">Sample Usage 2</button>
      <button id="customizeBtn" type="button" class="btn">Customize Usage</button>
    </div>
  </section>

  <section class="workflow-strip">
    <div class="container workflow-steps" aria-label="Guided workflow">
      <span class="step-chip">1. Model</span>
      <span class="step-chip">2. Scenarios</span>
      <span class="step-chip">3. Run</span>
      <span class="step-chip">4. Results</span>
      <span class="step-chip">5. Export</span>
    </div>
  </section>

  <main class="page container">
    <section id="presetCardsSection" class="panel">
      <div class="panel-title">
        <h2>Quick Start Presets</h2>
      </div>
      <div class="preset-cards">
        <article class="preset-card">
          <h3>Predator-Prey Preset</h3>
          <p>Use Sample Usage 1. Suggested: 20 steps, 3 episodes. Expected outputs: prey/predator trends and extinction signal.</p>
        </article>
        <article class="preset-card">
          <h3>Policy-Firm Preset</h3>
          <p>Use Sample Usage 2. Suggested: 24 steps, 4 episodes. Expected outputs: welfare/compliance variation and inequality profile.</p>
        </article>
      </div>
    </section>

    <section id="sample1Section" class="panel">
      <div class="panel-title">
        <h2>Sample Usage 1 (3 Layers)</h2>
      </div>
      <div id="sample1GridHost">
        <div id="sampleGrid" class="grid"></div>
      </div>
      <div class="paper-notes">
        <h4>Component Roles → Key Parameters</h4>
        <ul>
          <li>L1 Climate seasonal driver + shocks: seasonal amplitude = 0.4 (condition: 0.4 or 0.8), period = 12, shock probability = 0.1</li>
          <li>L1 Landscape patch quality + graph: number of patches = 12, habitat fragmentation = 0.2, movement cost = 0.2 (condition: 0.2 or 0.5)</li>
          <li>L2 Prey density growth + risk foraging: initial prey = 40, intrinsic growth rate = 0.55, carrying capacity = 120, risk level = 0.55, foraging sensitivity (beta) = 0.3, visibility scaling (gamma) = 0.2</li>
          <li>L2 Predator consumption response: initial predator = 9, conversion rate = 0.3, mortality rate = 0.1</li>
          <li>L2 Movement dispersal on graph: dispersal rate = 0.35 in [0, 1]</li>
          <li>L3 Aggregator per-step & episode metrics: extinction threshold = 1.0</li>
        </ul>
        <h4>Component Purpose → Parameters</h4>
        <ul>
          <li>Evolution (NSGA-II) multi-objective search: population size = 24, generations = 6-8, weights = (-1, -1)</li>
          <li>Schema trait genes: risk in [0, 1], dispersal in [0, 1]</li>
          <li>Scenarios environment grid: seasonal amplitude in {0.4, 0.8}, habitat fragmentation in {0.2, 0.5}</li>
          <li>Participants policies/traits: baseline risk/dispersal = (0.55, 0.35), evolved = champion</li>
          <li>Scoring biomass metric: PREY.PREY.mean_x (mean prey population)</li>
          <li>Voting episode winner rule: choose maximum score (per episode)</li>
        </ul>
      </div>
      <p class="hint">Editable. Click a cell for detailed parameters.</p>
    </section>

    <section id="runControlsSection" class="panel">
      <div class="panel-title">
        <h2>Run Controls</h2>
        <div class="panel-actions">
          <button id="cancelBtn" type="button" class="btn ghost" disabled>Cancel</button>
          <button id="replayBtn" type="button" class="btn ghost" disabled>Replay Last Run</button>
          <button id="resetPresetBtn" type="button" class="btn ghost">Reset Preset</button>
          <button id="startTourBtn" type="button" class="btn ghost">Help / Start Tour</button>
          <button id="exportBtn" type="button" class="btn">Export Bundle</button>
          <label for="importInput" class="btn">Import Bundle</label>
          <input id="importInput" type="file" accept="application/json" class="visually-hidden" />
          <button id="shareBtn" type="button" class="btn">Copy Share Link</button>
        </div>
      </div>
      <div class="controls">
        <label>
          Steps
          <input id="stepsInput" type="number" min="1" value="20" />
        </label>
        <label>
          Episodes
          <input id="episodesInput" type="number" min="1" value="1" />
        </label>
        <label>
          Seed
          <input id="seedInput" type="number" value="123" />
        </label>
        <button id="runBtn" type="button" class="btn primary" disabled>Run Simulation</button>
      </div>
      <div id="status" class="status" role="status" aria-live="polite">Loading Pyodide…</div>
      <div id="unsavedIndicator" class="status-meta">All changes saved</div>
      <pre id="shareLinkOutput" class="output small text-panel hidden" aria-live="polite"></pre>
      <p class="hint">Run limits: max 500 steps, 20 episodes, 64 scenarios, 45s runtime.</p>
      <pre id="validationErrors" class="output small text-panel hidden" aria-live="polite"></pre>
      <pre id="runtimeErrors" class="output small text-panel hidden" aria-live="polite"></pre>
      <div class="run-facts-card">
        <div class="panel-title">
          <h3>Run Facts</h3>
          <button id="copyDebugBtn" type="button" class="btn ghost" disabled>Copy Debug Report</button>
        </div>
        <pre id="runFactsOutput" class="output small text-panel">No run yet.</pre>
      </div>
    </section>

    <section id="resultsSection" class="panel">
      <div class="panel-title">
        <h2>Results</h2>
      </div>
      <div class="results-tabs">
        <button type="button" class="btn is-active" data-results-tab="overview">Overview</button>
        <button type="button" class="btn" data-results-tab="per-step">Per-step</button>
        <button type="button" class="btn" data-results-tab="scenario-compare">Scenario Compare</button>
        <button type="button" class="btn" data-results-tab="pixel">Pixel Art</button>
        <button type="button" class="btn" data-results-tab="interpretation">Interpretation</button>
      </div>
      <div class="results-pane" data-results-pane="overview">
        <h3>Episode Summary</h3>
        <div class="chart-wrap">
          <canvas id="episodeChart" width="600" height="320"></canvas>
        </div>
        <pre id="episodeSummary" class="output small text-panel"></pre>
        <div class="table-actions">
          <button id="summaryCopyBtn" type="button" class="btn ghost">Copy Table CSV</button>
          <button id="summaryCsvBtn" type="button" class="btn ghost">Download Table CSV</button>
        </div>
        <div class="summary-table-wrap">
          <table id="summaryTable" class="summary-table">
            <thead id="summaryTableHead">
              <tr id="summaryTableHeadRow">
                <th>Episode</th>
                <th>Seed</th>
                <th>Metrics</th>
              </tr>
            </thead>
            <tbody id="summaryTableBody"></tbody>
          </table>
        </div>
      </div>
      <div class="results-pane hidden" data-results-pane="per-step">
        <h3>Per-step Preview</h3>
        <div class="chart-wrap">
          <canvas id="stepChart" width="600" height="260"></canvas>
        </div>
        <pre id="stepPreview" class="output small text-panel"></pre>
      </div>
      <div class="results-pane hidden" data-results-pane="scenario-compare">
        <h3>Scenario Compare</h3>
        <div id="scenarioGrid" class="scenario-grid"></div>
      </div>
      <div class="results-pane hidden" data-results-pane="pixel">
        <h3>Pixel Art Replay</h3>
        <div class="pixel-controls">
          <label>
            Scenario
            <select id="pixelScenarioSelect"></select>
          </label>
          <label>
            Episode
            <select id="pixelEpisodeSelect"></select>
          </label>
          <label>
            Speed
            <select id="pixelSpeedSelect">
              <option value="0.5">0.5x</option>
              <option value="1" selected>1x</option>
              <option value="2">2x</option>
            </select>
          </label>
          <button id="pixelPlayBtn" type="button" class="btn ghost">Play</button>
          <label class="pixel-scrub">
            Step
            <input id="pixelScrub" type="range" min="0" max="0" step="1" value="0" />
            <span id="pixelStepLabel">t=0</span>
          </label>
        </div>
        <div class="pixel-wrap">
          <canvas id="pixelCanvas" width="360" height="220"></canvas>
        </div>
        <h4 class="pixel-legend-title">High-Pixel Box Legend</h4>
        <div id="pixelLegend" class="pixel-legend"></div>
        <p class="hint">Each box maps to one stream, its live metric key, and core parameters listed below.</p>
      </div>
      <div class="results-pane hidden" data-results-pane="interpretation">
        <h3>Interpretation (Heuristic Summary)</h3>
        <pre id="interpretationOutput" class="output interpretation"></pre>
      </div>
    </section>

    <section id="exportSection" class="panel">
      <div class="panel-title">
        <h2>Export and Citation</h2>
      </div>
      <div class="results">
        <div>
          <h3>Publication Bundle</h3>
          <p class="hint">Contains config, run result, debug report, and checksum metadata.</p>
          <button id="publicationExportBtn" type="button" class="btn primary">Export Publication Bundle</button>
          <pre id="runMetaOutput" class="output small text-panel"></pre>
        </div>
        <div>
          <h3>BibTeX</h3>
          <pre id="bibtexOutput" class="output small text-panel"></pre>
        </div>
      </div>
    </section>

    <section id="sample2Section" class="panel hidden">
      <div class="panel-title">
        <h2>Sample Usage 2</h2>
      </div>
      <div id="sample2GridHost"></div>
      <div class="paper-notes">
        <h4>Component Roles → Key Parameters</h4>
        <ul>
          <li>L1 Government policy: tax rate = 0.1 (condition: 0.1 or 0.3)</li>
          <li>L1 Industry compliance intensity: inspection probability = 0.2, penalty intensity = 0.3</li>
          <li>L1 Market signal: base demand = 100, growth rate = 0.02, market power effect = 0.2</li>
          <li>L2 Firm group (agents): firm count = 4, costs = 0.4, initial balance = 1.0</li>
          <li>L2 Payoff accounting (micro): strategy = Collaborate (rule)</li>
          <li>L3 Alliance rule: rule = Join (rule)</li>
          <li>L3 Group gaming rule: mode = Cooperate (rule)</li>
          <li>L4 Total wealth aggregator: total wealth</li>
          <li>L4 Inequality aggregator: balance inequality (Gini)</li>
        </ul>
        <h4>Component Purpose → Parameters</h4>
        <ul>
          <li>Policy conditions: tax rate scenarios {0.1, 0.3}</li>
          <li>Compliance enforcement: inspection probability = 0.2, penalty intensity = 0.3</li>
          <li>Market dynamics: base demand = 100, growth rate = 0.02, market power effect = 0.2</li>
          <li>Agent capacity: firm count = 4, initial balance = 1.0, costs = 0.4</li>
          <li>Agent rules: payoff strategy = Collaborate, alliance rule = Join, group gaming rule = Cooperate</li>
          <li>Aggregator: total wealth, balance inequality (Gini)</li>
        </ul>
      </div>
    </section>

    <section id="customizeSection" class="panel">
      <div class="panel-title">
        <h2>Customize Settings</h2>
        <div class="panel-actions">
          <button id="addLayerBtn" type="button" class="btn">+ Layer</button>
          <button id="addStreamBtn" type="button" class="btn">+ Stream</button>
          <button id="resetBtn" type="button" class="btn ghost">Reset</button>
        </div>
      </div>
      <div id="customGrid" class="grid"></div>
      <p class="hint">Each cell shows one parameter. Click for full settings.</p>
    </section>
  </main>

  <footer class="container footer-links">
    <a href="./terms.html">Terms</a>
    <a href="./privacy.html">Privacy</a>
    <a href="./disclaimer.html">Disclaimer</a>
  </footer>

  <div id="modal" class="modal" aria-hidden="true">
    <div class="modal-card">
      <div class="modal-header">
        <h3>Edit Stream</h3>
        <button id="closeModalBtn" type="button" class="icon">×</button>
      </div>
      <form id="modalForm" class="modal-body">
        <label>
          Display Name
          <input id="streamName" type="text" required />
        </label>
          <label>
            Search Type
            <input id="streamTypeSearch" type="text" placeholder="Type to filter stream types..." />
          </label>
          <label>
            Type
            <select id="streamType">
            <option value="Custom">Custom</option>
            <option value="GovernmentPolicy">Government Policy</option>
            <option value="IndustryRegime">Industry Regime</option>
            <option value="MarketSignal">Market Signal</option>
            <option value="FirmGroup">Firm Group</option>
            <option value="AllianceMediator">Alliance Mediator</option>
            <option value="AllianceRule">Alliance Rule</option>
            <option value="GroupGamingRule">Group Gaming Rule</option>
            <option value="PayoffAccounting">Payoff Accounting</option>
            <option value="PayoffAccountingGroup">Payoff Accounting (Group)</option>
            <option value="AggregatorFirm">Aggregator Metrics</option>
            <option value="AggregatorTotalWealth">Total Wealth Aggregator</option>
            <option value="AggregatorInequality">Inequality Aggregator</option>
            <option value="Climate">Climate</option>
            <option value="Landscape">Landscape</option>
            <option value="PreyRisk">PreyRisk</option>
            <option value="PredatorResponse">PredatorResponse</option>
            <option value="Movement">Movement</option>
            <option value="Aggregator">Aggregator</option>
            <option value="Price">Price</option>
            <option value="Policy">Policy</option>
            </select>
          </label>
          <p class="hint">Tip: <strong>condition</strong> categories define scenarios; <strong>rule</strong> categories select behavior.</p>
        <fieldset class="agent-box">
          <legend>Agent</legend>
          <label class="agent-toggle">
            <input id="agentEnabled" type="checkbox" />
            This stream is an agent (learns, thinks, acts)
          </label>
          <label>
            Agent Capacity
            <input id="agentCapacity" type="number" min="1" step="1" value="1" />
          </label>
          <p class="agent-hint">Use this to mark key simulation units, such as firms in Sample Usage 2.</p>
        </fieldset>
        <div id="paramFields" class="param-grid"></div>
        <pre id="encodedPreview" class="output small text-panel"></pre>
        <div class="modal-actions">
          <button type="button" id="addParamBtn" class="btn ghost">Add Parameter</button>
          <button type="button" id="addCatBtn" class="btn ghost">Add Categorical</button>
          <button type="button" id="deleteBtn" class="btn ghost">Delete Stream</button>
          <button type="submit" class="btn primary">Save</button>
        </div>
      </form>
    </div>
  </div>

  <div id="tourModal" class="modal" aria-hidden="true">
    <div class="modal-card tour-card" role="dialog" aria-modal="true" aria-labelledby="tourTitle">
      <div class="modal-header">
        <h3 id="tourTitle">Welcome to HEAS Playground</h3>
        <button id="tourCloseBtn" type="button" class="icon" aria-label="Close introduction">×</button>
      </div>
      <div class="tour-progress" id="tourProgress" aria-live="polite">Step 1 of 5</div>
      <div class="tour-body">
        <h4 id="tourStepTitle">Choose a usage mode</h4>
        <p id="tourStepText">Start with Sample Usage 1/2 or open Customize Usage to build your own setup.</p>
      </div>
      <div class="modal-actions">
        <button id="tourBackBtn" type="button" class="btn ghost">Back</button>
        <button id="tourSkipBtn" type="button" class="btn ghost">Skip</button>
        <button id="tourNextBtn" type="button" class="btn primary">Next</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/pyodide/v0.26.4/full/pyodide.js"></script>
  <script type="module" src="app.js"></script>
</body>
</html>
